import{_ as n,c as l,a as i,b as h,r as k,o as e}from"./app-CMUkE7qF.js";const t={};function p(d,s){const a=k("Mermaid");return e(),l("div",null,[s[0]||(s[0]=i(`<h1 id="四-优化与源码" tabindex="-1"><a class="header-anchor" href="#四-优化与源码"><span>四. 优化与源码</span></a></h1><h2 id="_1-优化" tabindex="-1"><a class="header-anchor" href="#_1-优化"><span>1. 优化</span></a></h2><h3 id="_1-1-扩展序列化算法" tabindex="-1"><a class="header-anchor" href="#_1-1-扩展序列化算法"><span>1.1 扩展序列化算法</span></a></h3><p>序列化，反序列化主要用在消息正文的转换上</p><ul><li>序列化时，需要将 Java 对象变为要传输的数据（可以是 byte[]，或 json 等，最终都需要变成 byte[]）</li><li>反序列化时，需要将传入的正文数据还原成 Java 对象，便于处理</li></ul><p>目前的代码仅支持 Java 自带的序列化，反序列化机制，核心代码如下</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 反序列化</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">[] body </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[bodyLength];</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">byteByf</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(body);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ObjectInputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ObjectInputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ByteArrayInputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(body));</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Message</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> message </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (Message) </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readObject</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setSequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(sequenceId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 序列化</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ByteArrayOutputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> out </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ByteArrayOutputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ObjectOutputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(out).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeObject</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(message);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">[] bytes </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">toByteArray</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了支持更多序列化算法，抽象一个 Serializer 接口</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Serializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 反序列化方法</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> deserialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">clazz</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 序列化方法</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">serialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>提供两个实现，我这里直接将实现加入了枚举类 Serializer.Algorithm 中</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> SerializerAlgorithm</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Serializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">	// Java 实现</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">    Java</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> deserialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">clazz</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                ObjectInputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ObjectInputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ByteArrayInputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(bytes));</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> object </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readObject</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (T) object;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> | </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ClassNotFoundException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RuntimeException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;SerializerAlgorithm.Java 反序列化错误&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">serialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                ByteArrayOutputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> out </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ByteArrayOutputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ObjectOutputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(out).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeObject</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(object);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">toByteArray</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RuntimeException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;SerializerAlgorithm.Java 序列化错误&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }, </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // Json 实现(引入了 Gson 依赖)</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">    Json</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> deserialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">clazz</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Gson</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fromJson</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(bytes, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">StandardCharsets</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">UTF_8</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">), clazz);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">serialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Gson</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">toJson</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(object).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">StandardCharsets</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">UTF_8</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 需要从协议的字节中得到是哪种序列化算法</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SerializerAlgorithm</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getByInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> type</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">        SerializerAlgorithm</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">[] array </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SerializerAlgorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">values</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (type </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> type </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> array</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> IllegalArgumentException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;超过 SerializerAlgorithm 范围&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> array[type];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>增加配置类和配置文件</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Properties</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">InputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getResourceAsStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;/application.properties&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            properties </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(in);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ExceptionInInitializerError</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getServerPort</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> value </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getProperty</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;server.port&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(value </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 8080</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">parseInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(value);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Serializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Algorithm</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getSerializerAlgorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> value </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getProperty</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;serializer.algorithm&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(value </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Serializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Algorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Java</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Serializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Algorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">valueOf</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(value);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>配置文件</p><div class="language-properties line-numbers-mode" data-highlighter="shiki" data-ext="properties" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-properties"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#F97583;">serializer.algorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">=Json</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>修改编解码器</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;"> * 必须和 LengthFieldBasedFrameDecoder 一起使用，确保接到的 ByteBuf 消息是完整的</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;"> */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> MessageCodecSharable</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> MessageToMessageCodec</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">ByteBuf</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Message</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Message</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">outList</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        ByteBuf</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> out </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">alloc</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">buffer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 1. 4 字节的魔数</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[]{</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 2. 1 字节的版本,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 3. 1 字节的序列化方式 jdk 0 , json 1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getSerializerAlgorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">ordinal</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 4. 1 字节的指令类型</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getMessageType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 5. 4 个字节</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getSequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 无意义，对齐填充</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">0xff</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 6. 获取内容的字节数组</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">[] bytes </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getSerializerAlgorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">serialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 7. 长度</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 8. 写入内容</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(bytes);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        outList</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(out);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> decode</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ByteBuf</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">List</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> magicNum </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> version </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> serializerAlgorithm </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 0 或 1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> messageType </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 0,1,2...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> sequenceId </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readByte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> length </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">[] bytes </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> byte</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[length];</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(bytes, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, length);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 找到反序列化算法</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Serializer</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Algorithm</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> algorithm </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Serializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Algorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">values</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()[serializerAlgorithm];</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 确定具体消息类型</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Message</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; messageClass </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getMessageClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(messageType);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Message</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> message </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> algorithm</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">deserialize</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(messageClass, bytes);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//        log.debug(&quot;{}, {}, {}, {}, {}, {}&quot;, magicNum, version, serializerType, messageType, sequenceId, length);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//        log.debug(&quot;{}&quot;, message);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(message);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>其中确定具体消息类型，可以根据 <code>消息类型字节</code> 获取到对应的 <code>消息 class</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Data</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Message</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Serializable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 根据消息类型字节，获得对应的消息 class</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * </span><span style="--shiki-light:#A626A4;--shiki-light-font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;">@param</span><span style="--shiki-light:#383A42;--shiki-light-font-style:italic;--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;"> messageType</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;"> 消息类型字节</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * </span><span style="--shiki-light:#A626A4;--shiki-light-font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;">@return</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;"> 消息 class</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getMessageClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> messageType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(messageType);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> sequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> messageType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getMessageType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> LoginRequestMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> LoginResponseMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ChatRequestMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ChatResponseMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupCreateRequestMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupCreateResponseMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupJoinRequestMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 6</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupJoinResponseMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupQuitRequestMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupQuitResponseMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 9</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupChatRequestMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupChatResponseMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupMembersRequestMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 12</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> GroupMembersResponseMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 13</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> PingMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 14</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> PongMessage </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 15</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Integer</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Message</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;&gt; messageClasses </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> HashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(LoginRequestMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">LoginRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(LoginResponseMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">LoginResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(ChatRequestMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">ChatRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(ChatResponseMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">ChatResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupCreateRequestMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupCreateRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupCreateResponseMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupCreateResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupJoinRequestMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupJoinRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupJoinResponseMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupJoinResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupQuitRequestMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupQuitRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupQuitResponseMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupQuitResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupChatRequestMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupChatRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupChatResponseMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupChatResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupMembersRequestMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupMembersRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(GroupMembersResponseMessage, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GroupMembersResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h3 id="_1-2-参数调优" tabindex="-1"><a class="header-anchor" href="#_1-2-参数调优"><span>1.2 参数调优</span></a></h3><h4 id="_1-connect-timeout-millis" tabindex="-1"><a class="header-anchor" href="#_1-connect-timeout-millis"><span>1）CONNECT_TIMEOUT_MILLIS</span></a></h4><ul><li><p>属于 SocketChannal 参数</p></li><li><p>用在客户端建立连接时，如果在指定毫秒内无法连接，会抛出 timeout 异常</p></li><li><p>SO_TIMEOUT 主要用在阻塞 IO，阻塞 IO 中 accept，read 等都是无限等待的，如果不希望永远阻塞，使用它调整超时时间</p></li></ul><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> TestConnectionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        NioEventLoopGroup</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> group </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NioEventLoopGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Bootstrap</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(group)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">option</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">ChannelOption</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">CONNECT_TIMEOUT_MILLIS</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">NioSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">handler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> LoggingHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            ChannelFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> future </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            future</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 断点1</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">printStackTrace</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;timeout&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">shutdownGracefully</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>另外源码部分 <code>io.netty.channel.nio.AbstractNioChannel.AbstractNioUnsafe#connect</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> connect</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> remoteAddress, </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> localAddress, </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // Schedule connect timeout.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> connectTimeoutMillis </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getConnectTimeoutMillis</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (connectTimeoutMillis </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        connectTimeoutFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">schedule</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {                </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                ChannelPromise</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> connectPromise </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> AbstractNioChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">connectPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                ConnectTimeoutException</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> cause </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ConnectTimeoutException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;connection timed out: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> remoteAddress); </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 断点2</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (connectPromise </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> connectPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">tryFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(cause)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    close</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">voidPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }, connectTimeoutMillis, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">MILLISECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">	// ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h4 id="_2-so-backlog" tabindex="-1"><a class="header-anchor" href="#_2-so-backlog"><span>2）SO_BACKLOG</span></a></h4><ul><li>属于 ServerSocketChannal 参数</li></ul>`,27)),h(a,{code:"eJx1kMGqwjAQRff9ilm+x0Ph6c6FoLagKF1YEVxJHEcN1LRNpoJ/7yRaaRG35565k4mjqiaDFGt1tuoaRaWyrFGXyjAgKAeYazLc4c5zR/ZGtsurENyNA2mtqROqECpEKvkVRw5647HUjeCgzfHntwVy7ZiMIAwIBWFhDCG/mdf++5Dt0igtmCCnE0NxCq7AfZakcdNYCStrfopWny/B9A3eXM+2jemHB6EU/mAyW35WJ9lmMl0tsnkStx4y7AdbFnkix37b1x4XrdcUtG5/fpLc+QBVknuT"}),s[1]||(s[1]=i(`<ol><li>第一次握手，client 发送 SYN 到 server，状态修改为 SYN_SEND，server 收到，状态改变为 SYN_REVD，并将该请求放入 sync queue 队列</li><li>第二次握手，server 回复 SYN + ACK 给 client，client 收到，状态改变为 ESTABLISHED，并发送 ACK 给 server</li><li>第三次握手，server 收到 ACK，状态改变为 ESTABLISHED，将该请求从 sync queue 放入 accept queue</li></ol><p>其中</p><ul><li><p>在 linux 2.2 之前，backlog 大小包括了两个队列的大小，在 2.2 之后，分别用下面两个参数来控制</p></li><li><p>sync queue - 半连接队列</p><ul><li>大小通过 /proc/sys/net/ipv4/tcp_max_syn_backlog 指定，在 <code>syncookies</code> 启用的情况下，逻辑上没有最大值限制，这个设置便被忽略</li></ul></li><li><p>accept queue - 全连接队列</p><ul><li>其大小通过 /proc/sys/net/core/somaxconn 指定，在使用 listen 函数时，内核会根据传入的 backlog 参数与系统参数，取二者的较小值</li><li>如果 accpet queue 队列满了，server 将发送一个拒绝连接的错误信息到 client</li></ul></li></ul><p>netty 中</p><p>可以通过 option(ChannelOption.SO_BACKLOG, 值) 来设置大小</p><p>可以通过下面源码查看默认大小</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> DefaultServerSocketChannelConfig</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> DefaultChannelConfig</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                                              implements</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> ServerSocketChannelConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> volatile</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> backlog </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> NetUtil</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">SOMAXCONN</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>课堂调试关键断点为：<code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><p>oio 中更容易说明，不用 debug 模式</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Server</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        ServerSocket</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ss </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ServerSocket</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8888</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Socket</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> accept </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ss</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">accept</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(accept);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端启动 4 个</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Client</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Socket</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Socket</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot; connecting...&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            s</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> InetSocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;localhost&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8888</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">),</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot; connected...&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            s</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getOutputStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot; connecting timeout...&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">printStackTrace</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>第 1，2，3 个客户端都打印，但除了第一个处于 accpet 外，其它两个都处于 accept queue 中</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Tue</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Apr </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">21</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">28</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> CST </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">2020</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> connecting...</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Tue</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Apr </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">21</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">28</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> CST </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">2020</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> connected...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第 4 个客户端连接时</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-"><span class="line"><span>Tue Apr 21 20:53:58 CST 2020 connecting...</span></span>
<span class="line"><span>Tue Apr 21 20:53:59 CST 2020 connecting timeout...</span></span>
<span class="line"><span>java.net.SocketTimeoutException: connect timed out</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-ulimit-n" tabindex="-1"><a class="header-anchor" href="#_3-ulimit-n"><span>3）ulimit -n</span></a></h4><ul><li>属于操作系统参数</li></ul><h4 id="_4-tcp-nodelay" tabindex="-1"><a class="header-anchor" href="#_4-tcp-nodelay"><span>4）TCP_NODELAY</span></a></h4><ul><li>属于 SocketChannal 参数</li></ul><h4 id="_5-so-sndbuf-so-rcvbuf" tabindex="-1"><a class="header-anchor" href="#_5-so-sndbuf-so-rcvbuf"><span>5）SO_SNDBUF &amp; SO_RCVBUF</span></a></h4><ul><li>SO_SNDBUF 属于 SocketChannal 参数</li><li>SO_RCVBUF 既可用于 SocketChannal 参数，也可以用于 ServerSocketChannal 参数（建议设置到 ServerSocketChannal 上）</li></ul><h4 id="_6-allocator" tabindex="-1"><a class="header-anchor" href="#_6-allocator"><span>6）ALLOCATOR</span></a></h4><ul><li>属于 SocketChannal 参数</li><li>用来分配 ByteBuf， ctx.alloc()</li></ul><h4 id="_7-rcvbuf-allocator" tabindex="-1"><a class="header-anchor" href="#_7-rcvbuf-allocator"><span>7）RCVBUF_ALLOCATOR</span></a></h4><ul><li>属于 SocketChannal 参数</li><li>控制 netty 接收缓冲区大小</li><li>负责入站数据的分配，决定入站缓冲区的大小（并可动态调整），统一采用 direct 直接内存，具体池化还是非池化由 allocator 决定</li></ul><h3 id="_1-3-rpc-框架" tabindex="-1"><a class="header-anchor" href="#_1-3-rpc-框架"><span>1.3 RPC 框架</span></a></h3><h4 id="_1-准备工作" tabindex="-1"><a class="header-anchor" href="#_1-准备工作"><span>1）准备工作</span></a></h4><p>这些代码可以认为是现成的，无需从头编写练习</p><p>为了简化起见，在原来聊天项目的基础上新增 Rpc 请求和响应消息</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Data</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Message</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Serializable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 省略旧的代码</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> RPC_MESSAGE_TYPE_REQUEST </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 101</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">  RPC_MESSAGE_TYPE_RESPONSE </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 102</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(RPC_MESSAGE_TYPE_REQUEST, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">RpcRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        messageClasses</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(RPC_MESSAGE_TYPE_RESPONSE, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">RpcResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>请求消息</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Getter</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">ToString</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">callSuper</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcRequestMessage</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 调用的接口全限定名，服务端根据它找到实现</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> interfaceName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 调用接口中的方法名</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> methodName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 方法返回类型</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; returnType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 方法参数类型数组</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">[] parameterTypes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 方法参数值数组</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">[] parameterValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> sequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> interfaceName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> methodName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">returnType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">parameterTypes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">parameterValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">        super</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setSequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(sequenceId);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">interfaceName</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> interfaceName;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">methodName</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> methodName;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">returnType</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> returnType;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">parameterTypes</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> parameterTypes;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">parameterValue</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> parameterValue;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getMessageType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> RPC_MESSAGE_TYPE_REQUEST;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>响应消息</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Data</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">ToString</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">callSuper</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcResponseMessage</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> Message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 返回值</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> returnValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     * 异常值</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> exceptionValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getMessageType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> RPC_MESSAGE_TYPE_RESPONSE;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>服务器架子</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcServer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        NioEventLoopGroup</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> boss </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NioEventLoopGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        NioEventLoopGroup</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> worker </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NioEventLoopGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        LoggingHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> LOGGING_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> LoggingHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">LogLevel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">DEBUG</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        MessageCodecSharable</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> MESSAGE_CODEC </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> MessageCodecSharable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // rpc 请求消息处理器，待实现</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        RpcRequestMessageHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> RPC_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcRequestMessageHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            ServerBootstrap</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> serverBootstrap </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ServerBootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            serverBootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">NioServerSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            serverBootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(boss, worker);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            serverBootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">childHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelInitializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ProcotolFrameDecoder</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(LOGGING_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(MESSAGE_CODEC);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(RPC_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Channel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> serverBootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">InterruptedException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;server error&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            boss</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">shutdownGracefully</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            worker</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">shutdownGracefully</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>客户端架子</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcClient</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        NioEventLoopGroup</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> group </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NioEventLoopGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        LoggingHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> LOGGING_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> LoggingHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">LogLevel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">DEBUG</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        MessageCodecSharable</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> MESSAGE_CODEC </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> MessageCodecSharable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // rpc 响应消息处理器，待实现</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        RpcResponseMessageHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> RPC_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcResponseMessageHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Bootstrap</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">NioSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(group);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">handler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelInitializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ProcotolFrameDecoder</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(LOGGING_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(MESSAGE_CODEC);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(RPC_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Channel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;localhost&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;client error&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">shutdownGracefully</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>服务器端的 service 获取</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> ServicesFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Properties</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; map </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ConcurrentHashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">InputStream</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> in </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getResourceAsStream</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;/application.properties&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            properties </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(in);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Set</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; names </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">stringPropertyNames</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            for</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> names) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">endsWith</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;Service&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                    Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; interfaceClass </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">forName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(name);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                    Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; instanceClass </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">forName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">properties</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getProperty</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(name));</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    map</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(interfaceClass, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">instanceClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">newInstance</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> | </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ClassNotFoundException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> | </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">InstantiationException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> | </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">IllegalAccessException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ExceptionInInitializerError</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getService</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">interfaceClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (T) </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(interfaceClass);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>相关配置 application.properties</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-"><span class="line"><span>serializer.algorithm=Json</span></span>
<span class="line"><span>cn.itcast.server.service.HelloService=cn.itcast.server.service.HelloServiceImpl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-服务器-handler" tabindex="-1"><a class="header-anchor" href="#_2-服务器-handler"><span>2）服务器 handler</span></a></h4><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">ChannelHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Sharable</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcRequestMessageHandler</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> SimpleChannelInboundHandler</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">RpcRequestMessage</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> channelRead0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">RpcRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        RpcResponseMessage</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> response </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        response</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setSequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getSequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 获取真正的实现对象</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            HelloService</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> service </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (HelloService)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ServicesFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getService</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">forName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getInterfaceName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 获取要调用的方法</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Method</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> method </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> service</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getMethod</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getMethodName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getParameterTypes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 调用方法</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> invoke </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> method</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">invoke</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(service, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">message</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getParameterValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 调用成功</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            response</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setReturnValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(invoke);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">printStackTrace</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 调用异常</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            response</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setExceptionValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 返回结果</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeAndFlush</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(response);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h4 id="_3-客户端代码第一版" tabindex="-1"><a class="header-anchor" href="#_3-客户端代码第一版"><span>3）客户端代码第一版</span></a></h4><p>只发消息</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcClient</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        NioEventLoopGroup</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> group </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NioEventLoopGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        LoggingHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> LOGGING_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> LoggingHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">LogLevel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">DEBUG</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        MessageCodecSharable</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> MESSAGE_CODEC </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> MessageCodecSharable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        RpcResponseMessageHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> RPC_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcResponseMessageHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Bootstrap</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">NioSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(group);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">handler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelInitializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ProcotolFrameDecoder</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(LOGGING_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(MESSAGE_CODEC);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(RPC_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Channel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;localhost&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            ChannelFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> future </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeAndFlush</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">                    1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">                    &quot;cn.itcast.server.service.HelloService&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">                    &quot;sayHello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    new</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[]{</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    new</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[]{</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;张三&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            )).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                    Throwable</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> cause </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;error&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, cause);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;client error&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">shutdownGracefully</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h4 id="_4-客户端-handler-第一版" tabindex="-1"><a class="header-anchor" href="#_4-客户端-handler-第一版"><span>4）客户端 handler 第一版</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">ChannelHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Sharable</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcResponseMessageHandler</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> SimpleChannelInboundHandler</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">RpcResponseMessage</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> channelRead0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">RpcResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;{}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, msg);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-客户端代码-第二版" tabindex="-1"><a class="header-anchor" href="#_5-客户端代码-第二版"><span>5）客户端代码 第二版</span></a></h4><p>包括 channel 管理，代理，接收结果</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcClientManager</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        HelloService</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> service </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getProxyService</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">HelloService</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">service</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sayHello</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;zhangsan&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//        System.out.println(service.sayHello(&quot;lisi&quot;));</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//        System.out.println(service.sayHello(&quot;wangwu&quot;));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 创建代理类</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getProxyService</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;">serviceClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        ClassLoader</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> loader </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> serviceClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getClassLoader</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Class</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;[] interfaces </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;"> Class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">[]{serviceClass};</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        //                                                            sayHello  &quot;张三&quot;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> o </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Proxy</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">newProxyInstance</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(loader, interfaces, (proxy, method, args) </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 1. 将方法调用转换为 消息对象</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> sequenceId </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SequenceIdGenerator</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            RpcRequestMessage</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> msg </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcRequestMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    sequenceId,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    serviceClass</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    method</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    method</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getReturnType</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    method</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getParameterTypes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    args</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            );</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 2. 将消息对象发送出去</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            getChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">writeAndFlush</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 3. 准备一个空 Promise 对象，来接收结果             指定 promise 对象异步接收结果线程</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            DefaultPromise</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; promise </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> DefaultPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;&gt;(</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            RpcResponseMessageHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">PROMISES</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(sequenceId, promise);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//            promise.addListener(future -&gt; {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//                // 线程</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//            });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 4. 等待 promise 结果</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">await</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 调用正常</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getNow</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 调用失败</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RuntimeException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (T) o;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Channel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> LOCK </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 获取唯一的 channel 对象</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Channel</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> getChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> channel;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        synchronized</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (LOCK) { </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//  t2</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// t1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> channel;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> channel;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 初始化 channel 方法</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        NioEventLoopGroup</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> group </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NioEventLoopGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        LoggingHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> LOGGING_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> LoggingHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">LogLevel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">DEBUG</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        MessageCodecSharable</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> MESSAGE_CODEC </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> MessageCodecSharable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        RpcResponseMessageHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> RPC_HANDLER </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> RpcResponseMessageHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Bootstrap</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">NioSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(group);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">handler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelInitializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">SocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ProcotolFrameDecoder</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(LOGGING_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(MESSAGE_CODEC);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(RPC_HANDLER);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> bootstrap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;localhost&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(future </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">shutdownGracefully</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;client error&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h4 id="_6-客户端-handler-第二版" tabindex="-1"><a class="header-anchor" href="#_6-客户端-handler-第二版"><span>6）客户端 handler 第二版</span></a></h4><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">ChannelHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Sharable</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> RpcResponseMessageHandler</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#B392F0;"> SimpleChannelInboundHandler</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">RpcResponseMessage</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    //                       序号      用来接收结果的 promise 对象</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Integer</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Promise</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;&gt; PROMISES </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ConcurrentHashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> channelRead0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">RpcResponseMessage</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        log</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;{}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, msg);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 拿到空的 promise</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        Promise</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; promise </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> PROMISES</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getSequenceId</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (promise </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> returnValue </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getReturnValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            Exception</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> exceptionValue </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> msg</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getExceptionValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(exceptionValue </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(exceptionValue);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(returnValue);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h2 id="_2-源码分析" tabindex="-1"><a class="header-anchor" href="#_2-源码分析"><span>2. 源码分析</span></a></h2><h3 id="_2-1-启动剖析" tabindex="-1"><a class="header-anchor" href="#_2-1-启动剖析"><span>2.1 启动剖析</span></a></h3><p>我们就来看看 netty 中对下面的代码是怎样进行处理的</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//1 netty 中使用 NioEventLoopGroup （简称 nio boss 线程）来封装线程和 selector</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Selector</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selector </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">open</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(); </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//2 创建 NioServerSocketChannel，同时会初始化它关联的 handler，以及为原生 ssc 存储 config</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">NioServerSocketChannel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> attachment </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NioServerSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//3 创建 NioServerSocketChannel 时，创建了 java 原生的 ServerSocketChannel</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ServerSocketChannel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> serverSocketChannel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ServerSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">open</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(); </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">serverSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">configureBlocking</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//4 启动 nio boss 线程执行接下来的操作</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//5 注册（仅关联 selector 和 NioServerSocketChannel），未关注事件</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">SelectionKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectionKey </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> serverSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">register</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(selector, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, attachment);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//6 head -&gt; 初始化器 -&gt; ServerBootstrapAcceptor -&gt; tail，初始化器是一次性的，只为添加 acceptor</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//7 绑定端口</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">serverSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> InetSocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//8 触发 channel active 事件，在 head 中关注 op_accept 事件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interestOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">OP_ACCEPT</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>入口 <code>io.netty.bootstrap.ServerBootstrap#bind</code></p><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelFuture</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> doBind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> localAddress) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">	// 1. 执行初始化和注册 regFuture 会由 initAndRegister 设置其是否完成，从而回调 3.2 处代码</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> regFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initAndRegister</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Channel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> regFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">regFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> regFuture;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 2. 因为是 initAndRegister 异步执行，需要分两种情况来看，调试时也需要通过 suspend 断点类型加以区分</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 2.1 如果已经完成</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">regFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isDone</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        ChannelPromise</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> promise </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">newPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 3.1 立刻调用 doBind0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        doBind0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(regFuture, channel, localAddress, promise);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 2.2 还没有完成</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> PendingRegistrationPromise</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> promise </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> PendingRegistrationPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(channel);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 3.2 回调 doBind0</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        regFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ChannelFutureListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> operationComplete</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> future</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">                Throwable</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> cause </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> future</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (cause </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                    // 处理异常...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(cause);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">registered</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">					// 3. 由注册线程去执行 doBind0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    doBind0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(regFuture, channel, localAddress, promise);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#initAndRegister</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelFuture</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initAndRegister</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">    Channel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channelFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">newChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 1.1 初始化 - 做的事就是添加一个初始化器 ChannelInitializer</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        init</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(channel);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 处理异常...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> DefaultChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> FailedChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">GlobalEventExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">INSTANCE</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 1.2 注册 - 做的事就是将原生 channel 注册到 selector 上</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">    ChannelFuture</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> regFuture </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">group</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">register</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(channel);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">regFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 处理异常...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> regFuture;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>关键代码 <code>io.netty.bootstrap.ServerBootstrap#init</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 这里 channel 实际上是 NioServerSocketChannel</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> channel) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelOption</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; options </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> options0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    synchronized</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (options) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        setChannelOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(channel, options, logger);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Map</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">AttributeKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; attrs </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> attrs0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    synchronized</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (attrs) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Entry</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">AttributeKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; e</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> attrs</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">entrySet</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">SuppressWarnings</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;unchecked&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            AttributeKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; key </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">AttributeKey</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">attr</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(key).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">    ChannelPipeline</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> EventLoopGroup</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> currentChildGroup </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> childGroup;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> currentChildHandler </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> childHandler;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Entry</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelOption</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;[] currentChildOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Entry</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">AttributeKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;[] currentChildAttrs</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    synchronized</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (childOptions) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        currentChildOptions </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> childOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">entrySet</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">toArray</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">newOptionArray</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    synchronized</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (childAttrs) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        currentChildAttrs </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> childAttrs</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">entrySet</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">toArray</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">newAttrArray</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 为 NioServerSocketChannel 添加初始化器</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    p</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelInitializer</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Channel</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPipeline</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> pipeline </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            ChannelHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> handler </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">handler</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (handler </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(handler);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 初始化器的职责是将 ServerBootstrapAcceptor 加入至 NioServerSocketChannel</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ServerBootstrapAcceptor</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>关键代码 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> register</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">EventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> eventLoop, </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 一些检查，略...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    AbstractChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> eventLoop;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">inEventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        register0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 首次执行 execute 方法时，会启动 nio 线程，之后注册等操作在 nio 线程上执行</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 因为只有一个 NioServerSocketChannel 因此，也只会有一个 boss nio 线程</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 这行代码完成的事实是 main -&gt; nio boss 线程的切换</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    register0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 日志记录...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            closeForcibly</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setClosed</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            safeSetFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise, t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> register0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setUncancellable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">ensureOpen</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> firstRegistration </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> neverRegistered;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 1.2.1 原生的 nio channel 绑定到 selector 上，注意此时没有注册 selector 关注事件，附件为 NioServerSocketChannel</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        doRegister</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        neverRegistered </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        registered </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 1.2.2 执行 NioServerSocketChannel 初始化器的 initChannel</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">invokeHandlerAddedIfNeeded</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 回调 3.2 io.netty.bootstrap.AbstractBootstrap#doBind0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        safeSetSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelRegistered</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 对应 server socket channel 还未绑定，isActive 为 false</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (firstRegistration) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isAutoRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                beginRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // Close the channel directly to avoid FD leak.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        closeForcibly</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setClosed</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        safeSetFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise, t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>关键代码 <code>io.netty.channel.ChannelInitializer#initChannel</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ctx) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">initMap</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(ctx)) { </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// Guard against re-entrance.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 1.2.2.1 执行初始化</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            initChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">((C) </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            exceptionCaught</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(ctx, cause);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 1.2.2.2 移除初始化器</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">            ChannelPipeline</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> pipeline </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#doBind0</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">// 3.1 或 3.2 执行 doBind0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> doBind0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> regFuture, </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> channel,</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> localAddress, </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">regFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(localAddress, promise).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">ChannelFutureListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">CLOSE_ON_FAILURE</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">regFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>关键代码 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#bind</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> bind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> localAddress, </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">    assertEventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setUncancellable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">ensureOpen</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Boolean</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">TRUE</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">equals</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getOption</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">ChannelOption</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">SO_BROADCAST</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        localAddress </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> InetSocketAddress </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">        !</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">((InetSocketAddress) localAddress).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isAnyLocalAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">        !</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">PlatformDependent</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isWindows</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">PlatformDependent</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">maybeSuperUser</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 记录日志...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> wasActive </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> isActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 3.3 执行端口绑定</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        doBind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(localAddress);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        safeSetFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise, t);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        closeIfClosed</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">wasActive </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> isActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        invokeLater</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 3.4 触发 active 事件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">    safeSetSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>3.3 关键代码 <code>io.netty.channel.socket.nio.NioServerSocketChannel#doBind</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> doBind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">SocketAddress</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> localAddress) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">PlatformDependent</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">javaVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        javaChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(localAddress, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getBacklog</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        javaChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">socket</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">bind</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(localAddress, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getBacklog</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.4 关键代码 <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> channelActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ctx) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">	// 触发 read (NioServerSocketChannel 上的 read 不是读取数据，只是为了触发 channel 的事件注册)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">    readIfIsAutoRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关键代码 <code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> doBeginRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // Channel.read() or ChannelHandlerContext.read() was called</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SelectionKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectionKey </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isValid</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    readPending </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> interestOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interestOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // readInterestOp 取值是 16，在 NioServerSocketChannel 创建时初始化好，代表关注 accept 事件</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ((interestOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> readInterestOp) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interestOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(interestOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> readInterestOp);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h3 id="_2-2-nioeventloop-剖析" tabindex="-1"><a class="header-anchor" href="#_2-2-nioeventloop-剖析"><span>2.2 NioEventLoop 剖析</span></a></h3><p>NioEventLoop 线程不仅要处理 IO 事件，还要处理 Task（包括普通任务和定时任务），</p><p>提交任务代码 <code>io.netty.util.concurrent.SingleThreadEventExecutor#execute</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> task) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (task </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> NullPointerException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;task&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> inEventLoop </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> inEventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 添加任务，其中队列使用了 jctools 提供的 mpsc 无锁队列</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">    addTask</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(task);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">inEventLoop) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // inEventLoop 如果为 false 表示由其它线程来调用 execute，即首次调用，这时需要向 eventLoop 提交首个任务，启动死循环，会执行到下面的 doStartThread</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        startThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isShutdown</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 如果已经 shutdown，做拒绝逻辑，代码略...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">addTaskWakesUp </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> wakesUpForTask</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(task)) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 如果线程由于 IO select 阻塞了，添加的任务的线程需要负责唤醒 NioEventLoop 线程</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        wakeup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(inEventLoop);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>唤醒 select 阻塞线程<code>io.netty.channel.nio.NioEventLoop#wakeup</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> wakeup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> inEventLoop) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">inEventLoop </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> wakenUp</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">compareAndSet</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">wakeup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动 EventLoop 主循环 <code>io.netty.util.concurrent.SingleThreadEventExecutor#doStartThread</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> doStartThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    assert</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> thread </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    executor</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 将线程池的当前线程保存在成员变量中，以便后续使用</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            thread </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (interrupted) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                thread</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            updateLastExecutionTime</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 调用外部类 SingleThreadEventExecutor 的 run 方法，进入死循环，run 方法见下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                SingleThreadEventExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                success </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                logger</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#9ECBFF;">&quot;Unexpected exception from an event executor: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">				// 清理工作，代码略...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><code>io.netty.channel.nio.NioEventLoop#run</code> 主要任务是执行死循环，不断看有没有新任务，有没有 IO 事件</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // calculateStrategy 的逻辑如下：</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 有任务，会执行一次 selectNow，清除上一次的 wakeup 结果，无论有没有 IO 事件，都会跳过 switch</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 没有任务，会匹配 SelectStrategy.SELECT，看是否应当阻塞</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                switch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selectStrategy</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">calculateStrategy</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(selectNowSupplier, </span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">hasTasks</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    case</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SelectStrategy</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">CONTINUE</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                        continue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    case</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SelectStrategy</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">BUSY_WAIT</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    case</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SelectStrategy</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">SELECT</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                        // 因为 IO 线程和提交任务线程都有可能执行 wakeup，而 wakeup 属于比较昂贵的操作，因此使用了一个原子布尔对象 wakenUp，它取值为 true 时，表示该由当前线程唤醒</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                        // 进行 select 阻塞，并设置唤醒状态为 false</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                        boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> oldWakenUp </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> wakenUp</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getAndSet</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                        // 如果在这个位置，非 EventLoop 线程抢先将 wakenUp 置为 true，并 wakeup</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                        // 下面的 select 方法不会阻塞</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                        // 等 runAllTasks 处理完成后，到再循环进来这个阶段新增的任务会不会及时执行呢?</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                        // 因为 oldWakenUp 为 true，因此下面的 select 方法就会阻塞，直到超时</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                        // 才能执行，让 select 方法无谓阻塞</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                        select</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(oldWakenUp);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">wakenUp</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                            selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">wakeup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    default:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">IOException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                rebuildSelector0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                handleLoopException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(e);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                continue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            cancelledKeys </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            needsToSelectAgain </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // ioRatio 默认是 50</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ioRatio </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">ioRatio</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (ioRatio </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    processSelectedKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                    // ioRatio 为 100 时，总是运行完所有非 IO 任务</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    runAllTasks</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {                </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ioStartTime </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">nanoTime</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    processSelectedKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                    // 记录 io 事件处理耗时</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ioTime </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">nanoTime</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ioStartTime;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                    // 运行非 IO 任务，一旦超时会退出 runAllTasks</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    runAllTasks</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(ioTime </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ioRatio) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ioRatio);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            handleLoopException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isShuttingDown</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                closeAll</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">confirmShutdown</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            handleLoopException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h4 id="⚠️-注意" tabindex="-1"><a class="header-anchor" href="#⚠️-注意"><span>⚠️ 注意</span></a></h4><blockquote><p>这里有个费解的地方就是 wakeup，它既可以由提交任务的线程来调用（比较好理解），也可以由 EventLoop 线程来调用（比较费解），这里要知道 wakeup 方法的效果：</p><ul><li>由非 EventLoop 线程调用，会唤醒当前在执行 select 阻塞的 EventLoop 线程</li><li>由 EventLoop 自己调用，会本次的 wakeup 会取消下一次的 select 操作</li></ul></blockquote><p>参考下图</p><p>&lt;./../../../.vuepress/public/assets/img src=&quot;./../../../.vuepress/public/assets/img/0032.png&quot; /&gt;</p><p><code>io.netty.channel.nio.NioEventLoop#select</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> select</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> oldWakenUp) throws IOException {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">    Selector</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selector </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> currentTimeNanos </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">nanoTime</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 计算等待时间</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // * 没有 scheduledTask，超时时间为 1s</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // * 有 scheduledTask，超时时间为 \`下一个定时任务执行时间 - 当前时间\`</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectDeadLineNanos </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> currentTimeNanos </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> delayNanos</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(currentTimeNanos);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            long</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> timeoutMillis </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (selectDeadLineNanos </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> currentTimeNanos </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 500000L</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1000000L</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 如果超时，退出循环</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (timeoutMillis </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                    selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">selectNow</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 如果期间又有 task 退出循环，如果没这个判断，那么任务就会等到下次 select 超时时才能被执行</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // wakenUp.compareAndSet(false, true) 是让非 NioEventLoop 不必再执行 wakeup</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">hasTasks</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> wakenUp</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">compareAndSet</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">selectNow</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // select 有限时阻塞</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 注意 nio 有 bug，当 bug 出现时，select 方法即使没有时间发生，也不会阻塞住，导致不断空轮询，cpu 占用 100%</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectedKeys </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(timeoutMillis);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 计数加 1</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 醒来后，如果有 IO 事件、或是由非 EventLoop 线程唤醒，或者有任务，退出循环</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (selectedKeys </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> oldWakenUp </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> wakenUp</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> hasTasks</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> hasScheduledTasks</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interrupted</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">               	// 线程被打断，退出循环</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 记录日志</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            long</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> time </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> System</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">nanoTime</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (time </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">MILLISECONDS</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">toNanos</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(timeoutMillis) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> currentTimeNanos) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 如果超时，计数重置为 1，下次循环就会 break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 计数超过阈值，由 io.netty.selectorAutoRebuildThreshold 指定，默认 512</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 这是为了解决 nio 空轮询 bug</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            else</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (SELECTOR_AUTO_REBUILD_THRESHOLD </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> SELECTOR_AUTO_REBUILD_THRESHOLD) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 重建 selector</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                selector </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> selectRebuildSelector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(selectCnt);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            currentTimeNanos </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> time;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (selectCnt </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> MIN_PREMATURE_SELECTOR_RETURNS) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 记录日志</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">CancelledKeyException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 记录日志</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>处理 keys <code>io.netty.channel.nio.NioEventLoop#processSelectedKeys</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> processSelectedKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (selectedKeys </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 通过反射将 Selector 实现类中的就绪事件集合替换为 SelectedSelectionKeySet </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // SelectedSelectionKeySet 底层为数组实现，可以提高遍历性能（原本为 HashSet）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        processSelectedKeysOptimized</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        processSelectedKeysPlain</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">selectedKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> processSelectedKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> k, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">AbstractNioChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ch) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> AbstractNioChannel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">NioUnsafe</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> unsafe </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 当 key 取消或关闭时会导致这个 key 无效</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isValid</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 无效时处理...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> readyOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> k</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readyOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 连接事件</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ((readyOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">OP_CONNECT</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> ops </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> k</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interestOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            ops </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;=</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> ~</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">OP_CONNECT</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            k</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interestOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(ops);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">finishConnect</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 可写事件</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ((readyOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">OP_WRITE</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            ch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">forceFlush</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 可读或可接入事件</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ((readyOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">OP_READ</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">OP_ACCEPT</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> readyOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 如果是可接入 io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 如果是可读 io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">CancelledKeyException</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> ignored</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">close</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">voidPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h3 id="_2-3-accept-剖析" tabindex="-1"><a class="header-anchor" href="#_2-3-accept-剖析"><span>2.3 accept 剖析</span></a></h3><p>nio 中如下代码，在 netty 中的流程</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">//1 阻塞直到事件发生</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Iterator</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">SelectionKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; iter </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selector</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">selectedKeys</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">iterator</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">iter</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">hasNext</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    //2 拿到一个事件</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">    SelectionKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> key </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> iter</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    //3 如果是 accept 事件</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isAcceptable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        //4 执行 accept</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">        SocketChannel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> channel </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> serverSocketChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">accept</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">configureBlocking</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        //5 关注 read 事件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        channel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">register</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(selector, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">SelectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">OP_READ</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>先来看可接入事件处理（accept）</p><p><code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> read</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    assert</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">inEventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelConfig</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> config </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPipeline</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> pipeline </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> RecvByteBufAllocator</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Handle</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> allocHandle </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">recvBufAllocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">reset</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(config);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> closed </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">    Throwable</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> exception </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            do</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">				// doReadMessages 中执行了 accept 并创建 NioSocketChannel 作为消息放入 readBuf</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // readBuf 是一个 ArrayList 用来缓存消息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> localRead </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> doReadMessages</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(readBuf);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (localRead </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (localRead </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    closed </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                    break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">				// localRead 为 1，就一条消息，即接收一个客户端连接</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">incMessagesRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(localRead);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">continueReading</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            exception </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> t;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> readBuf</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> size; i </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            readPending </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 触发 read 事件，让 pipeline 上的 handler 处理，这时是处理</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">readBuf</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(i));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        readBuf</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">clear</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readComplete</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelReadComplete</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (exception </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            closed </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> closeOnReadError</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(exception);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireExceptionCaught</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(exception);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (closed) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            inputShutdown </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isOpen</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                close</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">voidPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">readPending </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isAutoRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            removeReadOp</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>关键代码 <code>io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> channelRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ctx, </span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> msg) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 这时的 msg 是 NioSocketChannel</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Channel</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> child </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (Channel) msg;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // NioSocketChannel 添加  childHandler 即初始化器</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    child</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addLast</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(childHandler);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 设置选项</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">    setChannelOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(child, childOptions, logger);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Entry</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">AttributeKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#C18401;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">&gt; e</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> childAttrs) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        child</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">attr</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">AttributeKey</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getValue</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 注册 NioSocketChannel 到 nio worker 线程，接下来的处理也移交至 nio worker 线程</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        childGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">register</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(child).</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> ChannelFutureListener</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> operationComplete</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> future</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">future</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    forceClose</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(child, </span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">future</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">cause</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        forceClose</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(child, t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>又回到了熟悉的 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code> 方法</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> register</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">EventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> eventLoop, </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 一些检查，略...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    AbstractChannel</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> eventLoop;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">inEventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        register0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 这行代码完成的事实是 nio boss -&gt; nio worker 线程的切换</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            eventLoop</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                @</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                    register0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 日志记录...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            closeForcibly</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setClosed</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            safeSetFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise, t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> register0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelPromise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> promise) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">promise</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setUncancellable</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">ensureOpen</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> firstRegistration </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> neverRegistered;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        doRegister</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        neverRegistered </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        registered </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">		</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 执行初始化器，执行前 pipeline 中只有 head -&gt; 初始化器 -&gt; tail</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">invokeHandlerAddedIfNeeded</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 执行后就是 head -&gt; logging handler -&gt; my handler -&gt; tail</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        safeSetSuccess</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelRegistered</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (firstRegistration) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">                // 触发 pipeline 上 active 事件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isAutoRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">                beginRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        closeForcibly</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        closeFuture</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">setClosed</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        safeSetFailure</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(promise, t);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>回到了熟悉的代码 <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> channelActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">ChannelHandlerContext</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ctx) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelActive</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">	// 触发 read (NioSocketChannel 这里 read，只是为了触发 channel 的事件注册，还未涉及数据读取)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">    readIfIsAutoRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> doBeginRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // Channel.read() or ChannelHandlerContext.read() was called</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> SelectionKey</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectionKey </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isValid</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    readPending </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">	// 这时候 interestOps 是 0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> interestOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interestOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> ((interestOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> readInterestOp) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 关注 read 事件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        selectionKey</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">interestOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(interestOps </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> readInterestOp);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h3 id="_2-4-read-剖析" tabindex="-1"><a class="header-anchor" href="#_2-4-read-剖析"><span>2.4 read 剖析</span></a></h3><p>再来看可读事件 <code>io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code>，注意发送的数据未必能够一次读完，因此会触发多次 nio read 事件，一次事件内会触发多次 pipeline read，一次事件会触发一次 pipeline read complete</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> read</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelConfig</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> config </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">shouldBreakReadReady</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(config)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        clearReadPending</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ChannelPipeline</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> pipeline </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // io.netty.allocator.type 决定 allocator 的实现</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> ByteBufAllocator</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> allocator </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">getAllocator</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">    // 用来分配 byteBuf，确定单次读取大小</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    final</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;"> RecvByteBufAllocator</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Handle</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> allocHandle </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> recvBufAllocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">    allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">reset</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(config);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">    ByteBuf</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> byteBuf </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> close </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        do</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            byteBuf </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">allocate</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(allocator);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 读取</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">lastBytesRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">doReadBytes</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(byteBuf));</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">lastBytesRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">                byteBuf</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">release</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                byteBuf </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                close </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">lastBytesRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (close) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                    readPending </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">incMessagesRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            readPending </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">            // 触发 read 事件，让 pipeline 上的 handler 处理，这时是处理 NioSocketChannel 上的 handler</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">            pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(byteBuf);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">            byteBuf </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        } </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 是否要继续循环</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">continueReading</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        allocHandle</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">readComplete</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">        // 触发 read complete 事件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">        pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">fireChannelReadComplete</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (close) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            closeOnRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(pipeline);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">Throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#FFAB70;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">        handleReadException</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(pipeline, byteBuf, t, close, allocHandle);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">readPending </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isAutoRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">            removeReadOp</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><code>io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#continueReading(io.netty.util.UncheckedBooleanSupplier)</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#e1e4e8;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#24292e;"><pre class="shiki shiki-themes one-light github-dark vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;"> continueReading</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E1E4E8;">UncheckedBooleanSupplier</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> maybeMoreDataSupplier) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">           // 一般为 true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;">           config</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">isAutoRead</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">           // respectMaybeMoreData 默认为 true</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">           // maybeMoreDataSupplier 的逻辑是如果预期读取字节与实际读取字节相等，返回 true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">           (</span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">respectMaybeMoreData </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#E45649;--shiki-dark:#E1E4E8;"> maybeMoreDataSupplier</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">           // 小于最大次数，maxMessagePerRead 默认 16</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">           totalMessages </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;"> maxMessagePerRead </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;">           // 实际读到了数据</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">           totalBytesRead </span><span style="--shiki-light:#383A42;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,123))])}const r=n(t,[["render",p]]),g=JSON.parse('{"path":"/blog/itheima/Netty/Netty04.html","title":"优化与源码","lang":"zh-CN","frontmatter":{"title":"优化与源码","icon":"logos:importio","order":2,"category":["itheima"],"tag":["Netty"],"description":"四. 优化与源码 1. 优化 1.1 扩展序列化算法 序列化，反序列化主要用在消息正文的转换上 序列化时，需要将 Java 对象变为要传输的数据（可以是 byte[]，或 json 等，最终都需要变成 byte[]） 反序列化时，需要将传入的正文数据还原成 Java 对象，便于处理 目前的代码仅支持 Java 自带的序列化，反序列化机制，核心代码如下 ...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"优化与源码\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-10-09T01:57:56.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"mishu\\",\\"url\\":\\"https://github.com/ToTryEveryThing/my-docs\\"}]}"],["meta",{"property":"og:url","content":"https://docs.beink.cn/blog/itheima/Netty/Netty04.html"}],["meta",{"property":"og:title","content":"优化与源码"}],["meta",{"property":"og:description","content":"四. 优化与源码 1. 优化 1.1 扩展序列化算法 序列化，反序列化主要用在消息正文的转换上 序列化时，需要将 Java 对象变为要传输的数据（可以是 byte[]，或 json 等，最终都需要变成 byte[]） 反序列化时，需要将传入的正文数据还原成 Java 对象，便于处理 目前的代码仅支持 Java 自带的序列化，反序列化机制，核心代码如下 ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-10-09T01:57:56.000Z"}],["meta",{"property":"article:tag","content":"Netty"}],["meta",{"property":"article:modified_time","content":"2024-10-09T01:57:56.000Z"}]]},"git":{"createdTime":1721356358000,"updatedTime":1728439076000,"contributors":[{"name":"mishu","username":"mishu","email":"riceuncle@outlook.com","commits":9,"url":"https://github.com/mishu"}],"changelog":[{"hash":"6f73239b58fca703dc113ad10ae79d7b8fb6fb92","time":1728439076000,"email":"riceuncle@outlook.com","author":"mishu","message":"icon"},{"hash":"fe88cf5919f7f045543f77d0b3021e6d14a6208c","time":1723793860000,"email":"riceuncle@outlook.com","author":"mishu","message":"seo"},{"hash":"c0c16af9fcda1b2a473c6115ece4587c0176f743","time":1723793860000,"email":"riceuncle@outlook.com","author":"mishu","message":"seo"},{"hash":"ded7f6a012b43f5beb1156f25518fdfa5109bbbd","time":1723186347000,"email":"riceuncle@outlook.com","author":"mishu","message":"seo"},{"hash":"3a085f15eab56f0caebef229080dac502d1b4394","time":1723186347000,"email":"riceuncle@outlook.com","author":"mishu","message":"seo"},{"hash":"a32f82de14ac899ca64a2b4a33a0f1964685d80c","time":1721357015000,"email":"riceuncle@outlook.com","author":"mishu","message":"up"},{"hash":"26e34260160521fc8efba9e6a697d3321d2e2a17","time":1721357015000,"email":"riceuncle@outlook.com","author":"mishu","message":"up"},{"hash":"8590351d722bbb38bc1b0fc64a178e990435a3b5","time":1721356358000,"email":"riceuncle@outlook.com","author":"mishu","message":"netty"},{"hash":"38b1db0fed81ca4fec876ef1c66a33cd4b228817","time":1721356358000,"email":"riceuncle@outlook.com","author":"mishu","message":"netty"}]},"readingTime":{"minutes":21.53,"words":6458},"filePathRelative":"blog/itheima/Netty/Netty04.md","excerpt":"\\n<!-- <iframe src=\\"//player.bilibili.com/player.html?isOutside=true&aid=802157994&bvid=BV1py4y1E7oA&cid=311829977&p=119\\" scrolling=\\"no\\" border=\\"0\\" frameborder=\\"no\\" framespacing=\\"0\\" allowfullscreen=\\"true\\"></iframe> -->\\n<h2>1. 优化</h2>\\n<h3>1.1 扩展序列化算法</h3>\\n<p>序列化，反序列化主要用在消息正文的转换上</p>\\n<ul>\\n<li>序列化时，需要将 Java 对象变为要传输的数据（可以是 byte[]，或 json 等，最终都需要变成 byte[]）</li>\\n<li>反序列化时，需要将传入的正文数据还原成 Java 对象，便于处理</li>\\n</ul>","autoDesc":true}');export{r as comp,g as data};
